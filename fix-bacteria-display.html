<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Correction Automatique - Affichage Bact√©ries</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .button:hover {
            background: #2563eb;
        }
        .button.danger {
            background: #dc2626;
        }
        .button.danger:hover {
            background: #b91c1c;
        }
        .button.success {
            background: #059669;
        }
        .button.success:hover {
            background: #047857;
        }
        .success { color: #059669; font-weight: bold; }
        .error { color: #dc2626; font-weight: bold; }
        .warning { color: #d97706; font-weight: bold; }
        .info { color: #0891b2; font-weight: bold; }
        .result {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .step {
            background: #e0f2fe;
            border-left: 4px solid #0891b2;
            padding: 10px;
            margin: 10px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background-color: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background-color: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>üîß Correction Automatique - Affichage Bact√©ries</h1>
    <p>Ce script corrige automatiquement les probl√®mes d'affichage des bact√©ries dans "Analyse en cours" et "Lectures en attente"</p>

    <div class="container">
        <h2>üéØ Actions de Correction</h2>
        <button class="button" onclick="diagnostiquerProbleme()">1. üîç Diagnostiquer le probl√®me</button>
        <button class="button success" onclick="corrigerAutomatiquement()">2. üîß Corriger automatiquement</button>
        <button class="button" onclick="verifierCorrection()">3. ‚úÖ V√©rifier la correction</button>
        <button class="button danger" onclick="reinitialiserTout()">4. üîÑ R√©initialiser tout</button>
    </div>

    <div class="container">
        <h3>üìä Progression</h3>
        <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div id="status">Pr√™t √† diagnostiquer...</div>
    </div>

    <div id="resultats" class="container">
        <h3>üìã R√©sultats</h3>
        <div id="output">Cliquez sur "Diagnostiquer le probl√®me" pour commencer...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://bkdcbrnfzgnafjwnryme.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrZGNicm5memduYWZqd25yeW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2ODA1MTAsImV4cCI6MjA2MTI1NjUxMH0.cdzP9f_Bg1TlrBs-v1DsOb5Iv-tfK0KURPwZn1hwYMU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let diagnosticResults = null;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function updateProgress(percent, status) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('status').textContent = status;
        }

        async function diagnostiquerProbleme() {
            clearOutput();
            updateProgress(0, 'Diagnostic en cours...');
            log('üîç DIAGNOSTIC COMPLET DU PROBL√àME', 'info');
            log('=====================================', 'info');

            try {
                // √âtape 1: V√©rifier les √©chantillons
                updateProgress(20, 'V√©rification des √©chantillons...');
                log('1Ô∏è‚É£ V√©rification des √©chantillons...', 'info');
                
                const { data: samples, error: samplesError } = await supabase
                    .from('samples')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (samplesError) throw samplesError;

                const waitingSamples = samples.filter(s => s.status === 'waiting_reading');
                const draftSamples = samples.filter(s => s.status === 'draft');
                
                log(`üìã Total √©chantillons: ${samples.length}`, 'info');
                log(`üìã √âchantillons 'waiting_reading': ${waitingSamples.length}`, 'info');
                log(`üìã √âchantillons 'draft': ${draftSamples.length}`, 'info');

                // √âtape 2: V√©rifier les bact√©ries
                updateProgress(40, 'V√©rification des bact√©ries...');
                log('2Ô∏è‚É£ V√©rification des bact√©ries...', 'info');
                
                const { data: bacteria, error: bacteriaError } = await supabase
                    .from('form_bacteria_selections')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (bacteriaError) throw bacteriaError;

                const pendingBacteria = bacteria.filter(b => b.status === 'pending');
                const inProgressBacteria = bacteria.filter(b => b.status === 'in_progress');
                
                log(`ü¶† Total bact√©ries: ${bacteria.length}`, 'info');
                log(`ü¶† Bact√©ries 'pending': ${pendingBacteria.length}`, 'info');
                log(`ü¶† Bact√©ries 'in_progress': ${inProgressBacteria.length}`, 'info');

                // √âtape 3: V√©rifier localStorage
                updateProgress(60, 'V√©rification du localStorage...');
                log('3Ô∏è‚É£ V√©rification du localStorage...', 'info');
                
                const localSelection = localStorage.getItem('lotfiv2-bacteria-selection');
                let localBacteria = [];
                if (localSelection) {
                    try {
                        localBacteria = JSON.parse(localSelection);
                        log(`üíæ localStorage: ${localBacteria.length} bact√©ries s√©lectionn√©es`, 'success');
                        log(`üíæ Bact√©ries: ${localBacteria.join(', ')}`, 'info');
                    } catch (e) {
                        log(`üíæ localStorage: Erreur de parsing - ${e.message}`, 'error');
                    }
                } else {
                    log(`üíæ localStorage: Aucune s√©lection trouv√©e`, 'warning');
                }

                // √âtape 4: Analyser les correspondances
                updateProgress(80, 'Analyse des correspondances...');
                log('4Ô∏è‚É£ Analyse des correspondances...', 'info');
                
                const sampleFormIds = [...new Set(samples.map(s => s.form_id).filter(Boolean))];
                const bacteriaFormIds = [...new Set(bacteria.map(b => b.form_id).filter(Boolean))];
                
                log(`üìù Form IDs √©chantillons: ${sampleFormIds.length}`, 'info');
                log(`üß¨ Form IDs bact√©ries: ${bacteriaFormIds.length}`, 'info');

                const matches = sampleFormIds.filter(id => bacteriaFormIds.includes(id));
                const orphanSamples = sampleFormIds.filter(id => !bacteriaFormIds.includes(id));
                const orphanBacteria = bacteriaFormIds.filter(id => !sampleFormIds.includes(id));

                // √âtape 5: Diagnostic final
                updateProgress(100, 'Diagnostic termin√©');
                log('5Ô∏è‚É£ DIAGNOSTIC FINAL', 'info');
                log('==================', 'info');

                diagnosticResults = {
                    samples: samples,
                    bacteria: bacteria,
                    waitingSamples: waitingSamples,
                    pendingBacteria: pendingBacteria,
                    localBacteria: localBacteria,
                    matches: matches,
                    orphanSamples: orphanSamples,
                    orphanBacteria: orphanBacteria
                };

                // Identifier les probl√®mes
                const problems = [];
                
                if (waitingSamples.length > 0 && pendingBacteria.length === 0) {
                    problems.push('‚ùå PROBL√àME 1: √âchantillons en attente mais aucune bact√©rie pending');
                }
                
                if (localBacteria.length > 0 && pendingBacteria.length === 0) {
                    problems.push('‚ùå PROBL√àME 2: Bact√©ries s√©lectionn√©es localement mais pas sauvegard√©es');
                }
                
                if (orphanSamples.length > 0) {
                    problems.push(`‚ùå PROBL√àME 3: ${orphanSamples.length} √©chantillons sans bact√©ries associ√©es`);
                }
                
                if (orphanBacteria.length > 0) {
                    problems.push(`‚ùå PROBL√àME 4: ${orphanBacteria.length} bact√©ries orphelines`);
                }

                if (problems.length === 0) {
                    log('‚úÖ AUCUN PROBL√àME D√âTECT√â !', 'success');
                    log('Les donn√©es semblent coh√©rentes.', 'success');
                } else {
                    log('üö® PROBL√àMES D√âTECT√âS:', 'error');
                    problems.forEach(problem => log(problem, 'error'));
                    log('', 'info');
                    log('üí° Cliquez sur "Corriger automatiquement" pour r√©soudre ces probl√®mes.', 'info');
                }

            } catch (error) {
                log(`‚ùå Erreur lors du diagnostic: ${error.message}`, 'error');
                updateProgress(0, 'Erreur de diagnostic');
            }
        }

        async function corrigerAutomatiquement() {
            if (!diagnosticResults) {
                log('‚ö†Ô∏è Veuillez d\'abord lancer le diagnostic !', 'warning');
                return;
            }

            clearOutput();
            updateProgress(0, 'Correction en cours...');
            log('üîß CORRECTION AUTOMATIQUE', 'info');
            log('==========================', 'info');

            try {
                const { waitingSamples, localBacteria, orphanSamples } = diagnosticResults;

                // √âtape 1: Identifier le formulaire cible
                updateProgress(20, 'Identification du formulaire...');
                log('1Ô∏è‚É£ Identification du formulaire cible...', 'info');

                let targetFormId = null;
                if (waitingSamples.length > 0) {
                    targetFormId = waitingSamples[0].form_id;
                    log(`üéØ Formulaire cible trouv√©: ${targetFormId}`, 'success');
                } else if (orphanSamples.length > 0) {
                    targetFormId = orphanSamples[0];
                    log(`üéØ Formulaire orphelin utilis√©: ${targetFormId}`, 'success');
                } else {
                    throw new Error('Aucun formulaire cible trouv√©');
                }

                // √âtape 2: Pr√©parer les bact√©ries √† cr√©er
                updateProgress(40, 'Pr√©paration des bact√©ries...');
                log('2Ô∏è‚É£ Pr√©paration des bact√©ries...', 'info');

                const bacteriaMapping = {
                    'entero': { name: 'Ent√©robact√©ries', delay: '24h', delayHours: 24 },
                    'ecoli': { name: 'Escherichia coli', delay: '24h', delayHours: 24 },
                    'coliformes': { name: 'Coliformes totaux', delay: '48h', delayHours: 48 },
                    'staphylocoques': { name: 'Staphylocoques', delay: '48h', delayHours: 48 },
                    'listeria': { name: 'Listeria', delay: '48h', delayHours: 48 },
                    'levures3j': { name: 'Levures/Moisissures', delay: '72h', delayHours: 72 },
                    'flores': { name: 'Flore totales', delay: '72h', delayHours: 72 },
                    'leuconostoc': { name: 'Leuconostoc', delay: '96h', delayHours: 96 },
                    'levures5j': { name: 'Levures/Moisissures (5j)', delay: '120h', delayHours: 120 }
                };

                // Utiliser les bact√©ries du localStorage ou des bact√©ries par d√©faut
                let bacteriaToCreate = localBacteria.length > 0 ? localBacteria : ['entero', 'listeria', 'levures3j'];
                
                log(`ü¶† Bact√©ries √† cr√©er: ${bacteriaToCreate.join(', ')}`, 'info');

                const calculateReadingDay = (delayHours) => {
                    const now = new Date();
                    const readingDate = new Date(now.getTime() + delayHours * 60 * 60 * 1000);
                    const dayNames = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
                    return dayNames[readingDate.getDay()];
                };

                const bacteriaEntries = bacteriaToCreate.map(bacteriaId => {
                    const bacteriaInfo = bacteriaMapping[bacteriaId];
                    if (!bacteriaInfo) {
                        log(`‚ö†Ô∏è Bact√©rie inconnue: ${bacteriaId}, utilisation de valeurs par d√©faut`, 'warning');
                        return {
                            form_id: targetFormId,
                            bacteria_name: bacteriaId,
                            bacteria_delay: '24h',
                            reading_day: 'Lundi',
                            status: 'pending',
                            created_at: new Date().toISOString(),
                            modified_at: new Date().toISOString()
                        };
                    }

                    const readingDay = calculateReadingDay(bacteriaInfo.delayHours);
                    const now = new Date().toISOString();

                    return {
                        form_id: targetFormId,
                        bacteria_name: bacteriaInfo.name,
                        bacteria_delay: bacteriaInfo.delay,
                        reading_day: readingDay,
                        status: 'pending',
                        created_at: now,
                        modified_at: now
                    };
                });

                // √âtape 3: Supprimer les anciennes bact√©ries
                updateProgress(60, 'Nettoyage des anciennes bact√©ries...');
                log('3Ô∏è‚É£ Suppression des anciennes bact√©ries...', 'info');

                const { error: deleteError } = await supabase
                    .from('form_bacteria_selections')
                    .delete()
                    .eq('form_id', targetFormId);

                if (deleteError) {
                    log(`‚ö†Ô∏è Erreur suppression: ${deleteError.message}`, 'warning');
                } else {
                    log('‚úÖ Anciennes bact√©ries supprim√©es', 'success');
                }

                // √âtape 4: Cr√©er les nouvelles bact√©ries
                updateProgress(80, 'Cr√©ation des nouvelles bact√©ries...');
                log('4Ô∏è‚É£ Cr√©ation des nouvelles bact√©ries...', 'info');

                const { data: insertedBacteria, error: insertError } = await supabase
                    .from('form_bacteria_selections')
                    .insert(bacteriaEntries)
                    .select();

                if (insertError) throw insertError;

                log(`‚úÖ ${insertedBacteria.length} bact√©ries cr√©√©es avec succ√®s !`, 'success');
                insertedBacteria.forEach(bacteria => {
                    log(`   - ${bacteria.bacteria_name} (${bacteria.bacteria_delay}) ‚Üí ${bacteria.reading_day}`, 'info');
                });

                // √âtape 5: Mettre √† jour le statut du formulaire
                updateProgress(90, 'Mise √† jour du statut...');
                log('5Ô∏è‚É£ Mise √† jour du statut du formulaire...', 'info');

                const { error: updateError } = await supabase
                    .from('samples')
                    .update({ status: 'waiting_reading' })
                    .eq('form_id', targetFormId);

                if (updateError) {
                    log(`‚ö†Ô∏è Erreur mise √† jour statut: ${updateError.message}`, 'warning');
                } else {
                    log('‚úÖ Statut mis √† jour vers "waiting_reading"', 'success');
                }

                // √âtape 6: Synchroniser localStorage
                updateProgress(100, 'Correction termin√©e !');
                log('6Ô∏è‚É£ Synchronisation localStorage...', 'info');

                localStorage.setItem('lotfiv2-bacteria-selection', JSON.stringify(bacteriaToCreate));
                log('‚úÖ localStorage synchronis√©', 'success');

                log('', 'info');
                log('üéâ CORRECTION TERMIN√âE AVEC SUCC√àS !', 'success');
                log('=====================================', 'success');
                log('üì± Rechargez les pages "Analyse en cours" et "Lectures en attente"', 'info');
                log('üîÑ Les bact√©ries devraient maintenant s\'afficher correctement', 'info');

            } catch (error) {
                log(`‚ùå Erreur lors de la correction: ${error.message}`, 'error');
                updateProgress(0, 'Erreur de correction');
            }
        }

        async function verifierCorrection() {
            clearOutput();
            updateProgress(0, 'V√©rification en cours...');
            log('‚úÖ V√âRIFICATION DE LA CORRECTION', 'info');
            log('=================================', 'info');

            try {
                // V√©rifier les √©chantillons waiting_reading
                updateProgress(33, 'V√©rification √©chantillons...');
                const { data: waitingSamples, error: samplesError } = await supabase
                    .from('samples')
                    .select('*')
                    .eq('status', 'waiting_reading');

                if (samplesError) throw samplesError;

                // V√©rifier les bact√©ries pending
                updateProgress(66, 'V√©rification bact√©ries...');
                const { data: pendingBacteria, error: bacteriaError } = await supabase
                    .from('form_bacteria_selections')
                    .select('*')
                    .in('status', ['pending', 'in_progress']);

                if (bacteriaError) throw bacteriaError;

                // V√©rifier localStorage
                updateProgress(100, 'V√©rification termin√©e');
                const localSelection = localStorage.getItem('lotfiv2-bacteria-selection');
                const localBacteria = localSelection ? JSON.parse(localSelection) : [];

                log(`üìã √âchantillons 'waiting_reading': ${waitingSamples.length}`, 'info');
                log(`ü¶† Bact√©ries 'pending/in_progress': ${pendingBacteria.length}`, 'info');
                log(`üíæ Bact√©ries localStorage: ${localBacteria.length}`, 'info');

                if (waitingSamples.length > 0 && pendingBacteria.length > 0) {
                    log('‚úÖ CORRECTION R√âUSSIE !', 'success');
                    log('Les bact√©ries devraient maintenant s\'afficher dans les deux pages.', 'success');
                } else {
                    log('‚ö†Ô∏è La correction n\'est pas compl√®te.', 'warning');
                    log('Essayez de relancer "Corriger automatiquement".', 'warning');
                }

            } catch (error) {
                log(`‚ùå Erreur lors de la v√©rification: ${error.message}`, 'error');
                updateProgress(0, 'Erreur de v√©rification');
            }
        }

        async function reinitialiserTout() {
            if (!confirm('‚ö†Ô∏è ATTENTION: Cette action va supprimer TOUTES les bact√©ries et r√©initialiser le localStorage. √ätes-vous s√ªr ?')) {
                return;
            }

            clearOutput();
            updateProgress(0, 'R√©initialisation...');
            log('üîÑ R√âINITIALISATION COMPL√àTE', 'warning');
            log('============================', 'warning');

            try {
                // Supprimer toutes les bact√©ries
                updateProgress(50, 'Suppression des bact√©ries...');
                const { error: deleteError } = await supabase
                    .from('form_bacteria_selections')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000'); // Supprimer tout

                if (deleteError) throw deleteError;

                // Vider localStorage
                updateProgress(75, 'Nettoyage localStorage...');
                localStorage.removeItem('lotfiv2-bacteria-selection');

                // Remettre les √©chantillons en draft
                updateProgress(100, 'R√©initialisation termin√©e');
                const { error: updateError } = await supabase
                    .from('samples')
                    .update({ status: 'draft' })
                    .eq('status', 'waiting_reading');

                if (updateError) throw updateError;

                log('‚úÖ R√©initialisation termin√©e', 'success');
                log('Toutes les bact√©ries ont √©t√© supprim√©es', 'info');
                log('localStorage vid√©', 'info');
                log('√âchantillons remis en statut "draft"', 'info');

            } catch (error) {
                log(`‚ùå Erreur lors de la r√©initialisation: ${error.message}`, 'error');
                updateProgress(0, 'Erreur de r√©initialisation');
            }
        }

        // Initialisation
        window.onload = function() {
            log('üöÄ Script de correction charg√© - Pr√™t √† diagnostiquer !', 'success');
        };
    </script>
</body>
</html> 