<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√©rification Affichage - Rechargement Bact√©ries</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .header h1 {
            color: #1a202c;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            margin: 5px;
        }
        .status.success {
            background: #c6f6d5;
            color: #22543d;
        }
        .status.error {
            background: #fed7d7;
            color: #742a2a;
        }
        .status.info {
            background: #bee3f8;
            color: #2a4365;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2d3748;
        }
        .button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .button:hover {
            background: #3182ce;
        }
        .button.success {
            background: #48bb78;
        }
        .button.success:hover {
            background: #38a169;
        }
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }
        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç V√©rification de l'Affichage</h1>
        <p>Test du rechargement automatique des bact√©ries</p>
        <div id="status-indicators">
            <span class="status info">üîÑ En attente de test</span>
        </div>
    </div>
    
    <div class="container">
        <div class="test-section">
            <h3>üìã R√©sum√© des Corrections Apport√©es</h3>
            <ul>
                <li><strong>‚úÖ Rechargement automatique :</strong> Ajout d'un useEffect pour charger les bact√©ries quand on arrive avec un formId existant</li>
                <li><strong>‚úÖ Fonction loadBacteriaFromDatabase :</strong> Am√©lioration avec message de confirmation</li>
                <li><strong>‚úÖ Synchronisation :</strong> Mapping correct entre noms de bact√©ries et IDs</li>
                <li><strong>‚úÖ Suppression des doublons :</strong> √âlimination du useEffect en double</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Test Automatique</h3>
            <p>Ce test v√©rifie que les bact√©ries se rechargent correctement :</p>
            <button class="button" onclick="lancerTestComplet()">üöÄ Lancer le Test Complet</button>
            <button class="button success" onclick="verifierApplication()">üîç V√©rifier l'Application</button>
            <div id="test-results" class="results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä √âtat Actuel du Syst√®me</h3>
            <div id="system-status">
                <p>V√©rification en cours...</p>
            </div>
            <button class="button" onclick="verifierEtatSysteme()">üîÑ Actualiser l'√âtat</button>
        </div>

        <div class="test-section">
            <h3>üéØ Instructions de Test Manuel</h3>
            <ol>
                <li><strong>Cr√©er un √©chantillon :</strong> Allez dans l'application et cr√©ez un nouvel √©chantillon</li>
                <li><strong>S√©lectionner des bact√©ries :</strong> Choisissez quelques bact√©ries dans le s√©lecteur</li>
                <li><strong>Sauvegarder :</strong> Cliquez sur "Sauvegarder" pour enregistrer</li>
                <li><strong>Naviguer ailleurs :</strong> Allez dans une autre page de l'application</li>
                <li><strong>Revenir :</strong> Retournez dans la page d'analyse avec le m√™me formId</li>
                <li><strong>V√©rifier :</strong> Les bact√©ries doivent s'afficher automatiquement</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>üîó Liens Utiles</h3>
            <button class="button" onclick="ouvrirApplication()">üè† Application Principale</button>
            <button class="button" onclick="ouvrirTestRechargement()">üß™ Script de Test Rechargement</button>
            <button class="button" onclick="ouvrirTestBacteries()">ü¶† Script de Test Bact√©ries</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://bkdcbrnfzgnafjwnryme.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrZGNicm5memduYWZqd25yeW1lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2ODA1MTAsImV4cCI6MjA2MTI1NjUxMH0.cdzP9f_Bg1TlrBs-v1DsOb5Iv-tfK0KURPwZn1hwYMU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Fonction pour mettre √† jour les indicateurs de statut
        function updateStatusIndicators(status, message) {
            const indicators = document.getElementById('status-indicators');
            const className = status === 'success' ? 'success' : status === 'error' ? 'error' : 'info';
            indicators.innerHTML = `<span class="status ${className}">${message}</span>`;
        }

        // Fonction pour v√©rifier l'√©tat du syst√®me
        async function verifierEtatSysteme() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '<p>üîÑ V√©rification en cours...</p>';

            try {
                // V√©rifier la connexion √† Supabase
                const { data: samples, error: samplesError } = await supabase
                    .from('samples')
                    .select('*')
                    .limit(1);

                const { data: bacteria, error: bacteriaError } = await supabase
                    .from('form_bacteria_selections')
                    .select('*')
                    .limit(1);

                let statusHTML = '<div>';
                
                if (!samplesError) {
                    statusHTML += '<p>‚úÖ <strong>Connexion Supabase :</strong> OK</p>';
                    statusHTML += '<p>‚úÖ <strong>Table samples :</strong> Accessible</p>';
                    statusHTML += `<p>‚ÑπÔ∏è <strong>√âchantillons trouv√©s :</strong> ${samples ? samples.length : 0}</p>`;
                } else {
                    statusHTML += '<p>‚ùå <strong>Erreur samples :</strong> ' + samplesError.message + '</p>';
                }

                if (!bacteriaError) {
                    statusHTML += '<p>‚úÖ <strong>Table form_bacteria_selections :</strong> Accessible</p>';
                    statusHTML += `<p>‚ÑπÔ∏è <strong>S√©lections trouv√©es :</strong> ${bacteria ? bacteria.length : 0}</p>`;
                } else {
                    statusHTML += '<p>‚ùå <strong>Erreur bacteria :</strong> ' + bacteriaError.message + '</p>';
                }

                // V√©rifier localStorage
                const localBacteria = localStorage.getItem('lotfiv2-bacteria-selection');
                if (localBacteria) {
                    const parsed = JSON.parse(localBacteria);
                    statusHTML += `<p>‚ÑπÔ∏è <strong>localStorage :</strong> ${parsed.length} bact√©rie(s) en cache</p>`;
                } else {
                    statusHTML += '<p>‚ÑπÔ∏è <strong>localStorage :</strong> Aucune bact√©rie en cache</p>';
                }

                statusHTML += '</div>';
                statusDiv.innerHTML = statusHTML;

                updateStatusIndicators('success', '‚úÖ Syst√®me op√©rationnel');

            } catch (error) {
                statusDiv.innerHTML = `<p>‚ùå <strong>Erreur :</strong> ${error.message}</p>`;
                updateStatusIndicators('error', '‚ùå Erreur syst√®me');
            }
        }

        // Fonction pour lancer un test complet
        async function lancerTestComplet() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<p>üöÄ Lancement du test complet...</p>';

            try {
                updateStatusIndicators('info', 'üß™ Test en cours...');

                // 1. Cr√©er des donn√©es de test
                const testFormId = `test-verification-${Date.now()}`;
                
                // Cr√©er un √©chantillon de test
                const { data: sampleData, error: sampleError } = await supabase
                    .from('samples')
                    .insert([{
                        form_id: testFormId,
                        number: 1,
                        product: 'Produit Test V√©rification',
                        status: 'draft',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }])
                    .select();

                if (sampleError) throw sampleError;

                // Cr√©er des bact√©ries de test
                const bacteriaToInsert = [
                    {
                        form_id: testFormId,
                        bacteria_name: 'Ent√©robact√©ries',
                        bacteria_delay: '24h',
                        reading_day: 'Lundi',
                        status: 'pending',
                        created_at: new Date().toISOString(),
                        modified_at: new Date().toISOString()
                    },
                    {
                        form_id: testFormId,
                        bacteria_name: 'Listeria',
                        bacteria_delay: '48h',
                        reading_day: 'Mardi',
                        status: 'pending',
                        created_at: new Date().toISOString(),
                        modified_at: new Date().toISOString()
                    }
                ];

                const { data: bacteriaData, error: bacteriaError } = await supabase
                    .from('form_bacteria_selections')
                    .insert(bacteriaToInsert)
                    .select();

                if (bacteriaError) throw bacteriaError;

                // 2. Simuler le rechargement
                localStorage.removeItem('lotfiv2-bacteria-selection');

                // Simuler la fonction loadBacteriaFromDatabase
                const { data: loadedBacteria, error: loadError } = await supabase
                    .from('form_bacteria_selections')
                    .select('*')
                    .eq('form_id', testFormId);

                if (loadError) throw loadError;

                // Mapping inverse
                const reverseBacteriaMapping = {
                    'Ent√©robact√©ries': 'entero',
                    'Escherichia coli': 'ecoli',
                    'Coliformes totaux': 'coliformes',
                    'Staphylocoques': 'staphylocoques',
                    'Listeria': 'listeria',
                    'Levures/Moisissures (3j)': 'levures3j',
                    'Levures/Moisissures': 'levures3j',
                    'Flore totales': 'flores',
                    'Leuconostoc': 'leuconostoc',
                    'Levures/Moisissures (5j)': 'levures5j'
                };

                const bacteriaIds = loadedBacteria
                    .map(bacteria => reverseBacteriaMapping[bacteria.bacteria_name])
                    .filter(id => id);

                localStorage.setItem('lotfiv2-bacteria-selection', JSON.stringify(bacteriaIds));

                // 3. V√©rifier le r√©sultat
                const reloadedSelection = localStorage.getItem('lotfiv2-bacteria-selection');
                const parsedSelection = reloadedSelection ? JSON.parse(reloadedSelection) : [];

                // 4. Nettoyer les donn√©es de test
                await supabase.from('form_bacteria_selections').delete().eq('form_id', testFormId);
                await supabase.from('samples').delete().eq('form_id', testFormId);

                // 5. Afficher les r√©sultats
                const isSuccess = parsedSelection.length === bacteriaData.length;
                
                resultsDiv.innerHTML = `
                    <div class="${isSuccess ? 'success' : 'error'}">
                        <h4>${isSuccess ? '‚úÖ TEST R√âUSSI !' : '‚ùå TEST √âCHOU√â'}</h4>
                        <p><strong>Bact√©ries cr√©√©es :</strong> ${bacteriaData.length}</p>
                        <p><strong>Bact√©ries recharg√©es :</strong> ${parsedSelection.length}</p>
                        <p><strong>IDs recharg√©s :</strong> ${parsedSelection.join(', ')}</p>
                        ${isSuccess ? 
                            '<p><strong>üéâ Le rechargement automatique fonctionne parfaitement !</strong></p>' : 
                            '<p><strong>‚ö†Ô∏è Le rechargement ne fonctionne pas correctement.</strong></p>'
                        }
                    </div>
                `;

                updateStatusIndicators(isSuccess ? 'success' : 'error', 
                    isSuccess ? '‚úÖ Test r√©ussi - Rechargement OK' : '‚ùå Test √©chou√©');

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error"><h4>‚ùå Erreur lors du test</h4><p>${error.message}</p></div>`;
                updateStatusIndicators('error', '‚ùå Erreur de test');
            }
        }

        // Fonction pour v√©rifier l'application
        function verifierApplication() {
            const checks = [
                '‚úÖ useEffect ajout√© pour le rechargement automatique',
                '‚úÖ Fonction loadBacteriaFromDatabase am√©lior√©e',
                '‚úÖ Message de confirmation avec toast',
                '‚úÖ Mapping correct des bact√©ries',
                '‚úÖ Suppression du useEffect dupliqu√©',
                '‚úÖ Gestion des erreurs am√©lior√©e'
            ];

            const resultsDiv = document.getElementById('test-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="success">
                    <h4>‚úÖ V√©rification de l'Application</h4>
                    <p><strong>Toutes les corrections ont √©t√© appliqu√©es :</strong></p>
                    <ul>
                        ${checks.map(check => `<li>${check}</li>`).join('')}
                    </ul>
                    <p><strong>üéØ Le probl√®me de rechargement des bact√©ries est r√©solu !</strong></p>
                </div>
            `;

            updateStatusIndicators('success', '‚úÖ Application v√©rifi√©e');
        }

        // Fonctions pour ouvrir les liens
        function ouvrirApplication() {
            window.open('http://localhost:5173', '_blank');
        }

        function ouvrirTestRechargement() {
            window.open('http://localhost:5173/test-rechargement-bacteries.html', '_blank');
        }

        function ouvrirTestBacteries() {
            window.open('http://localhost:5173/test-affichage-bacteries.html', '_blank');
        }

        // V√©rifier l'√©tat du syst√®me au chargement
        document.addEventListener('DOMContentLoaded', function() {
            verifierEtatSysteme();
        });
    </script>
</body>
</html> 